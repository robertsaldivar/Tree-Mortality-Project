---
title: "tree pops model"
author: "Trevor, Kaili, Robert"
date: "6/7/2020"
output: html_document
---

# Model of tree population (by age class) over time

```{r setup, include=FALSE}
library(SPEI)
library(tidyverse)
source("treepopsmodel.R") #get the function version of this (used below)
source("Drought2.R") #get the drought function
source("grazingsubmodel.R") #get the grazing and age function
```

```{r model inputs}
###ENTER THE DESIRED INPUTS HERE
t = 99 #the length of time (in years) for the model to run
timestep = 1 #the number of years per timestep - right now this needs to be 1
initialpops = c(1000,200,188,170,153,120,80,37,15,6) #pops in each age bin (age bins are 0-9,10-19,20-29, etc, with last being 90-99)
lpops = length(initialpops) #the NUMBER of different age bins

###For drought calculation: needs precipitation data in MONTHS for the entire time range AND the [timestep] years prior to the start of that range
#the FIRST value in this (i.e. index = 1) should be from [timestep] years before the intended start time
#by default we'll use the testing data available from the SPEI library
data(balance)
PMinusPET = balance$albuquerque #this version does the MORE DROUGHT version - the treepopsmodel.R version does Tampa, which is LESS DROUGHT

#there isn't enough data by default for 100 years
###For grazing calculation: needs the INITIAL herbivore POPULATION COUNT
herb_n = 200

# biomass scaling data frame
  ## We also need a biomass scaling data frame, which has age class-specific scaling factors. 
  ## For example, each individual in age class 1 has an average biomass (g C) of 0.5, etc. This 
  ## will help us convert between # of individuals and amount of biomass.
  biomassscaling <- data.frame("age_class" = c(1:10), "scaling" = c(1/2, 1/4, 1/5, 1/6, 1/7,
                                                                    1/8, 1/9, 1/10, 1/10, 1/10))
  
  
# alpha data frame
  ## Alpha values represents the "feeding rate" or "effect" of herbivores on trees, in each age 
  ## class. Because most full grown herbivores (deer) can likely eat the leaves of an entire 
  ## individual in age classes 1 and 2, we will assign higher alpha values to the smaller age 
  ## classes and lower alpha values to the larger age classes
  alphascaling <- data.frame("age_class" = c(1:10), "alpha" = c(0.0009, 0.0008, 0.0007, 0.00006, 0.00006, 0.00006, 
                                                                0.00005, 0.00004, 0.00003, 0.000001))

```

```{r model setup}
#initialize results matrix
pops = data.frame(t(initialpops))
colnames(pops) = c("0-9","10-19","20-29","30-39","40-49","50-59","60-69","70-79","80-89","90-99")
pops[2:(t+1),]=0
```

``` {r model loop}
#for the desired time length:
for(i in 1:t) { #run 1 timestep of the model
  
  #get the herbivore related deaths/rates [what should be returned is either:
  
  
  grazingoutput = grazingsubmodel(herb_n = herb_n,tree_n = pops[i,], biomassscaling = biomassscaling, alphascaling = alphascaling)
  herb_n = grazingoutput[[2]]
  newpops_g = grazingoutput[[1]]
  
  ######Drought related mortality
  
  #each +1 to i is +12 to the drought index we want
  #on 1st timestep we want from 1 to 12, which is i to 12i
  #on 2nd timestep we want from 13 to 24, which is 12(i-1)+1 to 12i
  
  
  startindex = 12*(i-1)+1
  endindex = 12*i
  d_input = PMinusPET[startindex:(endindex+100)] #it needs an input with a length of around 100 to function
  
  #get the drought related death rate
  dm_temp = drought_function(d_input)
  if(dm_temp[12,]>0.99){ #cap drought mortality at 99%
    dm_temp[12,]=0.99
  }
  
  
  droughtmort = dm_temp[12*timestep,]*pops[i,] #get the actual number that die of drought
  
  #get the actual new population
  newpops = newpops_g - droughtmort
  
  #no newpops bin can be less than 0
  for(i2 in 1:length(newpops)){
    if(newpops[i2] < 0){
      newpops[i2] = 0
    }
    
  }
  
  
  #add this to the next row in pops
  pops[(i+1),] = newpops
  
}

```

```{r visualize results}
#function for visualization:

getplottable_n = function(pops,t = 99,timestep = 1,usedifftitle = FALSE,specialtitle = "test"){
time_ = seq(from = 0, to = t)*timestep
pops2 = cbind.data.frame(pops,time_)
#"0-9","10-19","20-29","30-39","40-49","50-59","60-69","70-79","80-89","90-99"
colnames(pops2) = c("0-9","10-19","20-29","30-39","40-49","50-59","60-69","70-79","80-89","90-99","time")
#plot results vs time
title_ = ifelse(usedifftitle, paste("Difference in tree population over time:",specialtitle),"Tree population over time")
pops_display = pops2 %>% gather(key = "age_range",value = "population",-time)
p1 = ggplot(data = pops_display, aes(time, population, fill = age_range))+
  geom_col()+
  labs(x = "Time (years)", y = "Population", title = title_, fill = "Age Range") +theme_bw()
show(p1)
}
getplottable_n(pops)
```

```{r}
#Getting a summary of the data for tampa and albuquerque
summary(balance)
```

```{r drought}
#run the model again with less drought conditions (Tampa data)
pops_lessdrought = treepopsmodel(return_only_pops = TRUE)
#check if there was an actual difference
sum(pops-pops_lessdrought) #there is a substantial difference


getplottable_n(pops_lessdrought)

#the difference drought - less drought
drought_effect = pops - pops_lessdrought
getplottable_n(drought_effect,usedifftitle = TRUE,specialtitle = "Normal - Drought")
#it is not terribly informative since the predator prey cycle means there are also many timesteps where there are more individuals, but it's still possible to tell that the drought decreased the population size on average (more bars are negative, meaning lessdrought had more pops alive)

de_avg = drought_effect[1,] #AVERAGE drought effect by age class
lessdrought_avg = de_avg
for(i in 1:lpops){
  #for each age bin
  de_avg[i] = mean(drought_effect[,i])
  lessdrought_avg[i] = mean(pops_lessdrought[,i])
}
#average drought effect by age class, averaged across the entire run time
print(de_avg)

#percent reduction: average effect / less drought case
dperc_reduction = 100*de_avg / lessdrought_avg
print(dperc_reduction)
#all of them are negative, so drought reduced the population in every age class
#(we would test for statistical significance here if this were real research)

```

```{r moreherbivores}
#run the model again with more herbivores
pops_moreherbs = treepopsmodel(return_only_pops = TRUE,herb_n = 400) #this uses the Tampa climate
pops_lessherbs = treepopsmodel(return_only_pops = TRUE,herb_n = 200) #this uses the Tampa climate

#should be negative where there were fewer with more herbs
sum(pops_moreherbs-pops_lessherbs)
pops_lessherbs-pops_moreherbs
getplottable_n(pops_moreherbs)

#the difference herbivores - more drought
herb_effect = pops_moreherbs - pops_lessherbs
getplottable_n(herb_effect,usedifftitle = TRUE,specialtitle = "High - Low herbivore population") #this is actually the difference, not the population size, so should change the title


he_avg = herb_effect[1,] #AVERAGE herbivore effect by age class
lessherbs_avg = he_avg
for(i in 1:lpops){
  #for each age bin
  he_avg[i] = mean(herb_effect[,i])
  lessherbs_avg[i] = mean(pops_lessherbs[,i])
}
#average drought effect by age class, averaged across the entire run time
print(he_avg)
sum(he_avg[1:3])
sum(he_avg[4:10])

#percent change
hpercent_reduction = 100*he_avg / lessherbs_avg
print(hpercent_reduction)
#more herbivores means lower population in the lowest three age classes (values are positive so lower herbivore case was higher), but means higher population in the other age classes. The overall effect is reduction in population, with the impact on the lowest 3 age classes being roughly 10 times greater than the impact on all other age classes


```

```{r}
#Adding a place to see all of the graphs right next to each other!
getplottable_n(pops)
getplottable_n(pops_moredrought)
getplottable_n(pops_moreherbs)
```

