---
title: "tree pops model"
author: "Trevor, Kaili, Robert"
date: "6/7/2020"
output: html_document
---

# Model of tree population (by age class) over time

```{r setup, include=FALSE}
library(SPEI)
library(tidyverse)
source("treepopsmodel.R") #get the function version of this (used below)
source("Drought2.R") #get the drought function
source("grazingsubmodel.R") #get the grazing and age function
```

```{r model inputs}
###ENTER THE DESIRED INPUTS HERE
t = 99 #the length of time (in years) for the model to run
timestep = 1 #the number of years per timestep - right now this needs to be 1
initialpops = c(1000,200,188,170,153,120,80,37,15,6) #pops in each age bin (age bins are 0-9,10-19,20-29, etc, with last being 90-99)
lpops = length(initialpops) #the NUMBER of different age bins

###For drought calculation: needs precipitation data in MONTHS for the entire time range AND the [timestep] years prior to the start of that range
#the FIRST value in this (i.e. index = 1) should be from [timestep] years before the intended start time
#by default we'll use the testing data available from the SPEI library
data(balance)
PMinusPET = balance$albuquerque #this version does the MORE DROUGHT version - the treepopsmodel.R version does Tampa, which is LESS DROUGHT

#there isn't enough data by default for 100 years
###For grazing calculation: needs the INITIAL herbivore POPULATION COUNT
herb_n = 200

# biomass scaling data frame
  ## We also need a biomass scaling data frame, which has age class-specific scaling factors. 
  ## For example, each individual in age class 1 has an average biomass (g C) of 0.5, etc. This 
  ## will help us convert between # of individuals and amount of biomass.
  biomassscaling <- data.frame("age_class" = c(1:10), "scaling" = c(1/2, 1/4, 1/5, 1/6, 1/7,
                                                                    1/8, 1/9, 1/10, 1/10, 1/10))
  
  
# alpha data frame
  ## Alpha values represents the "feeding rate" or "effect" of herbivores on trees, in each age 
  ## class. Because most full grown herbivores (deer) can likely eat the leaves of an entire 
  ## individual in age classes 1 and 2, we will assign higher alpha values to the smaller age 
  ## classes and lower alpha values to the larger age classes
  alphascaling <- data.frame("age_class" = c(1:10), "alpha" = c(0.0009, 0.0008, 0.0007, 0.00006, 0.00006, 0.00006, 
                                                                0.00005, 0.00004, 0.00003, 0.000001))

```

```{r model setup}
#initialize results matrix
pops = data.frame(t(initialpops))
colnames(pops) = c("0-9","10-19","20-29","30-39","40-49","50-59","60-69","70-79","80-89","90-99")
pops[2:(t+1),]=0
```

``` {r model loop}
#for the desired time length:
for(i in 1:t) { #run 1 timestep of the model
  
  #get the herbivore related deaths/rates [what should be returned is either:
  
  
  grazingoutput = grazingsubmodel(herb_n = herb_n,tree_n = pops[i,], biomassscaling = biomassscaling, alphascaling = alphascaling)
  herb_n = grazingoutput[[2]]
  newpops_g = grazingoutput[[1]]
  
  ######Drought related mortality
  
  #each +1 to i is +12 to the drought index we want
  #on 1st timestep we want from 1 to 12, which is i to 12i
  #on 2nd timestep we want from 13 to 24, which is 12(i-1)+1 to 12i
  
  
  startindex = 12*(i-1)+1
  endindex = 12*i
  d_input = PMinusPET[startindex:(endindex+100)] #it needs an input with a length of around 100 to function
  
  #get the drought related death rate
  dm_temp = drought_function(d_input)
  if(dm_temp[12,]>0.99){ #cap drought mortality at 99%
    dm_temp[12,]=0.99
  }
  
  
  droughtmort = dm_temp[12*timestep,]*pops[i,] #get the actual number that die of drought
  
  #get the actual new population
  newpops = newpops_g - droughtmort
  
  #no newpops bin can be less than 0
  for(i2 in 1:length(newpops)){
    if(newpops[i2] < 0){
      newpops[i2] = 0
    }
    
  }
  
  
  #add this to the next row in pops
  pops[(i+1),] = newpops
  
}

```

```{r visualize results}
#function for visualization:

getplottable_n = function(pops,t = 99,timestep = 1,usedifftitle = FALSE,specialtitle = "test"){
time_ = seq(from = 0, to = t)*timestep
pops2 = cbind.data.frame(pops,time_)
#"0-9","10-19","20-29","30-39","40-49","50-59","60-69","70-79","80-89","90-99"
colnames(pops2) = c("0-9","10-19","20-29","30-39","40-49","50-59","60-69","70-79","80-89","90-99","time")
#plot results vs time
title_ = ifelse(usedifftitle, paste("Difference in tree population over time:",specialtitle),"Tree population over time")
pops_display = pops2 %>% gather(key = "age_range",value = "population",-time)
p1 = ggplot(data = pops_display, aes(time, population, fill = age_range))+
  geom_col()+
  labs(x = "Time (years)", y = "Population", title = title_, fill = "Age Range") +theme_bw()
show(p1)
}
getplottable_n(pops)
```

```{r}
#Getting a summary of the data for tampa and albuquerque
summary(balance)
```

```{r drought}
#run the model again with less drought conditions (Tampa data)
pops_lessdrought = treepopsmodel(return_only_pops = TRUE)
#check if there was an actual difference
sum(pops-pops_lessdrought) #there is a substantial difference


getplottable_n(pops_lessdrought)

#the difference drought - less drought
drought_effect = pops - pops_lessdrought
getplottable_n(drought_effect,usedifftitle = TRUE,specialtitle = "Normal - Drought")
#it is not terribly informative since the predator prey cycle means there are also many timesteps where there are more individuals, but it's still possible to tell that the drought decreased the population size on average (more bars are negative, meaning lessdrought had more pops alive)

de_avg = drought_effect[1,] #AVERAGE drought effect by age class
lessdrought_avg = de_avg
for(i in 1:lpops){
  #for each age bin
  de_avg[i] = mean(drought_effect[,i])
  lessdrought_avg[i] = mean(pops_lessdrought[,i])
}
#average drought effect by age class, averaged across the entire run time
print(de_avg)

#percent reduction: average effect / less drought case
dperc_reduction = 100*de_avg / lessdrought_avg
print(dperc_reduction)
#all of them are negative, so drought reduced the population in every age class
#(we would test for statistical significance here if this were real research)

```

```{r moreherbivores}
#run the model again with more herbivores
pops_moreherbs = treepopsmodel(return_only_pops = TRUE,herb_n = 400) #this uses the Tampa climate
pops_lessherbs = treepopsmodel(return_only_pops = TRUE,herb_n = 200) #this uses the Tampa climate

#should be negative where there were fewer with more herbs
sum(pops_moreherbs-pops_lessherbs)
pops_lessherbs-pops_moreherbs
getplottable_n(pops_moreherbs)

#the difference herbivores - more drought
herb_effect = pops_moreherbs - pops_lessherbs
getplottable_n(herb_effect,usedifftitle = TRUE,specialtitle = "High - Low herbivore population") #this is actually the difference, not the population size, so should change the title


he_avg = herb_effect[1,] #AVERAGE herbivore effect by age class
lessherbs_avg = he_avg
for(i in 1:lpops){
  #for each age bin
  he_avg[i] = mean(herb_effect[,i])
  lessherbs_avg[i] = mean(pops_lessherbs[,i])
}
#average drought effect by age class, averaged across the entire run time
print(he_avg)
sum(he_avg[1:3])
sum(he_avg[4:10])

#percent change
hpercent_reduction = 100*he_avg / lessherbs_avg
print(hpercent_reduction)
#more herbivores means lower population in the lowest three age classes (values are positive so lower herbivore case was higher), but means higher population in the other age classes. The overall effect is reduction in population, with the impact on the lowest 3 age classes being roughly 10 times greater than the impact on all other age classes


```

```{r}
#Adding a place to see all of the graphs right next to each other!
getplottable_n(pops)
getplottable_n(pops_moredrought)
getplottable_n(pops_moreherbs)
```

Write-up:

To answer our original question of how drought and grazing pressure affect population dynamics of a tree population over time, our model uses two subfunctions. The first subfunction utilizes sample monthly climatic water balance data, from the SPEI package library in R, to calculate mortality rates due to drought for each age class of the tree population. Data were first selected for Tampa, Florida because this is within the home range of the tree species (Quercus virginiana) for which parameter variables were selected in the drought subfunction. A second set of data were selected for Albuquerque, New Mexico because this location is representative of the Western U.S. region where drought is a common environmental condition (and where our conservation priorities lie).

The second subfunction accounts for grazing impact as well as natural growth and death rates, and returns the new timestep’s tree and herbivore populations. Herbivore population is a single number and tree population is by age class. This function combines the grazing and natural growth submodels - initially, these were separate functions, but the grazing mortality function is based off equations that simultaneously account for grazing and natural growth, so it was decided to combine them rather than to develop an entirely new way of accounting for grazing mortality.

The mortality rate from the drought function is then used to calculate drought mortality for each age class based on the previous timestep’s population, which is subtracted from the output of the grazing/growth function to obtain the true new population estimate. Any age class with a population value calculated as less than zero gets the population set to zero to prevent impossible negative values.

The model is able to quantify the changes in population size based on two major environmental factors. Because these two factors are present in Western U.S. forests which have experienced large declines in recent decades, we figured it would be important to quantify the magnitude of their effects on tree populations. Understanding these effects is critical to an overarching goal of forest conservation.

The subfunctions within our model make several assumptions. For the drought submodel function, we assume that the effect of drought on mortality rate does not differ across age classes. For the function which combines the growth and grazing submodels (“grazing subfunction”), we assume that the entire canopy of an individual tree is accessible to the herbivore at all times; herbivores are present at all time steps (they are not seasonal grazers); individual trees do not lose leaves seasonally (can be eaten by herbivores at all time steps); and the alpha values are based on the biological relationship between herbivores (i.e. deer) and trees (i.e. oaks), representing the effect of herbivores on trees and trees on herbivores. Additionally, herbivore carrying capacity is handled in a simplistic fashion, where the herbivore population is set to 400 (or another user-selected value) if it exceeds this number, but where growth rate does not slow as this value is approached. These assumptions add a level of uncertainty to our results because several physical and biological factors that may be important in a real, on-the-ground scenario are not accounted for in our model. Some examples of these factors include land management history of the area where the tree population is located or disturbance such as wildfire. Furthermore, there is potential uncertainty in our parameters that may not be avoidable. 

However, despite these shortcomings, the model does allow for the user to input species-specific values for several parameters, including mean wood density (WD) and mean surface leaf area (SLA) in the drought submodel. Altering these values allows the model to provide a more realistic output of modeling different tree species. We assessed sensitivity via a Sobol sensitivity analysis using three metrics: average population size of all age classes, average population size of the youngest age class, and average population size of the oldest three age classes.

For all three of these metrics, the sensitivity analysis indicated that changes to or uncertainty in the SLA value has a much stronger impact on the results than uncertainty in the WD value. Increasing SLA causes minimal changes in these metrics for SLA values between 0 and about 2.5, but causes a rapid nonlinear decline in the metrics between about 2.5 and 5. The three average population metrics continue to decline at a less steep, roughly linear rate, for SLA values above about 5. In contrast, there is no consistent pattern in any of these metrics with variation in wood density. Comparing the effect statistics for the two parameters shows (whether the main or total effect statistic is used) an effect of close to zero for wood density, with most of the effect being from specific leaf area. The sensitivity analysis is included in a separate RMD file because it is very time-consuming to run - see the knit version of this separate file for results and associated figures.

The grazing submodel also allows for species- and population-specific inputs of alpha values and carrying capacity for both the tree and herbivore populations, as well as growth rate. While no model is capable of representing patterns in nature with complete accuracy (and certainty), our model offers an initial attempt at quantifying potential mortality factors for tree populations in the Western U.S. that are of conservation concern. 

We tested the effect of drought and the effect of herbivory using three separate model runs. 
Low drought, low herbivory: Tampa climate data, initial herbivore population of 200
High drought, low herbivory: Albuquerque climate data, initial herbivore population 200
Low drought, high herbivory: Tampa climate data, initial herbivore population 400
To assess the impact of drought, model runs 1 and 2 were compared. To assess the impact of herbivory, runs 1 and 3 were compared.

Using Albuquerque data (more drought) reduces the average population compared to the less drought case. Average population is reduced in every age bin as well. The reduction is greater in lower age bins but this may partly be because these bins had more individuals to begin with. However, the percentage reduction is greater in these bins too, not just the absolute number of individuals lost.
This result is largely what we’d expected. With more drought, fewer trees are able to exist. The disproportionate impact on younger trees may be a result of the fact that young trees killed by drought are then unable to survive to reach old age, but this is not certain.
Using more herbivores (400 vs 200, with the Tampa climate in both) reduces the average population compared to the less herbivores case. The reduction is concentrated in the first half of the time interval and in the younger age bins. After about t = 45 there is no longer a difference between the two cases. There is a brief period around t = 10 where greater herbivore populations resulted in higher tree populations in one of the ‘mid-age’ bins. Otherwise, at all times the effect of more herbivores is either imperceptible or is to reduce the tree population.
These results are also largely what we’d expect – more herbivores leads to fewer trees, and has a disproportionate impact on younger trees that suffer more mortality from herbivory.
For the degree of increased drought that we tested, impacts were greater than the impact of doubling the herbivore population. The drier climate of Albuquerque led to a ~60% (for the youngest age class) to ~8% (for the oldest 7 age classes) reduction in average population, while the extra herbivores reduced population by between 6% (the youngest age class) and 0.003% (the oldest age class).
There is great potential for this model to be improved and expanded for future use. The results may have greater implications for environmental management because, given the results obtained for a certain location/scenario, the land manager can alter management plans in order to facilitate conservation. Examples of actions the land manager may take are preparing for upcoming drought events by hand-watering trees, or better managing local herbivore populations (through managed hunting, etc.) when grazing effects become too deadly. An additional next step for use of this model might be to assess herbivory impacts that are more constant over the model run time. The above analysis only looks at differences based on the initial herbivore population, and unsurprisingly these differences decline to become negligible after enough time has elapsed. Additionally modifying the herbivore carrying capacity might be an interesting way to assess this, but this might require changes to the way herbivore carrying capacity is handled by the model. As the model is improved and expanded, the breadth of implications for management will also expand. 


Full citations for the papers that each subfunction is based off of can be found in the files for the subfunctions themselves.
